{  
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"Deploy a service on AWS Fargate, hosted in a private subnet, but accessible via a public load balancer.",
    "Parameters":{  
		"NetworkStackName":{  
            "Type":"String",
            "Default":"main-vpc",
            "Description":"A name for the service"
        },
        "ServiceName":{  
            "Type":"String",
            "Default":"spring-boot-app",
            "Description":"A name for the service"
        },
        "ImageUrl":{  
            "Type":"String",
            "Default":"071592233073.dkr.ecr.eu-west-1.amazonaws.com/devopstestapp",
            "Description":"The url of a docker image that contains the application process"
        },
        "ContainerPort":{  
            "Type":"Number",
            "Default":80,
            "Description":"What port number the application inside the docker container is binding to"
        },
        "ContainerCpu":{  
            "Type":"Number",
            "Default":256,
            "Description":"How much CPU to give the container. 1024 is 1 CPU"
        },
        "ContainerMemory":{  
            "Type":"Number",
            "Default":512,
            "Description":"How much memory in megabytes to give the container"
        },
        "DesiredCount":{  
            "Type":"Number",
            "Default":1,
            "Description":"How many copies of the service task to run"
        },
        "TaskName":{  
            "Type":"String",
            "Description":"The name of the ECS task.",
            "Default":"spring-boot-app"
        },
        "TaskVersion":{  
            "Type":"String",
            "Description":"The version of the ECS task.",
            "Default":1
        }
    },
    "Resources":{  
        "ExecutionRole":{  
            "Properties":{  
                "AssumeRolePolicyDocument":{  
                    "Statement":[  
                        {  
                            "Action":[  
                                "sts:AssumeRole"
                            ],
                            "Effect":"Allow",
                            "Principal":{  
                                "Service":[  
                                    "ec2.amazonaws.com",
                                    "ecs-tasks.amazonaws.com",
                                    "ecs.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "Policies":[  

                ]
            },
            "Type":"AWS::IAM::Role"
        },
        "ExecutionRolePolicy":{  
            "Type":"AWS::IAM::Policy",
            "Properties":{  
                "PolicyName":"ExecutionRolePolicy",
                "PolicyDocument":{  
                    "Statement":[  
                        {  
                            "Effect":"Allow",
                            "Action":[  
                                "ecr:*",
                                "ecr:GetAuthorizationToken",
                                "ecr:BatchCheckLayerAvailability",
                                "ecr:GetDownloadUrlForLayer",
                                "ecr:BatchGetImage",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource":"*"
                        }
                    ]
                },
                "Roles":[  
                    {  
                        "Ref":"ExecutionRole"
                    }
                ]
            }
        },
        "SecurityGroupECS":{  
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{  
                "GroupDescription":"Allow traffic to ECS cluster",
                "VpcId": {
					"Fn::ImportValue": {
							  "Fn::Sub": "${NetworkStackName}-VPCID"
							}
				},
                "SecurityGroupIngress":[  
                    {  
                        "CidrIp":"0.0.0.0/0",
                        "FromPort":"8080",
                        "IpProtocol":"tcp",
                        "ToPort":"8080"
                    }
                ],
                "SecurityGroupEgress":[  
                    {  
                        "CidrIp":"0.0.0.0/0",
                        "FromPort":-1,
                        "IpProtocol":"-1",
                        "ToPort":-1
                    }
                ],
                "Tags":[  
                    {  
                        "Key":"Name",
                        "Value":"security-group-spring-boot-app"
                    }
                ]
            }
        },
        "ECSFargateCluster":{  
            "Type":"AWS::ECS::Cluster",
            "Properties":{  
                "ClusterName":"fargate-cluster"
            }
        },
        "TaskDefinition":{  
            "DependsOn":"ExecutionRole",
            "Type":"AWS::ECS::TaskDefinition",
            "Properties":{  
                "Family":{  
                    "Fn::Join":[  
                        "",
                        [  
                            {  
                                "Ref":"AWS::StackName"
                            },
                            "-",
                            {  
                                "Ref":"TaskName"
                            },
                            "-",
                            {  
                                "Ref":"TaskVersion"
                            }
                        ]
                    ]
                },
                "ExecutionRoleArn":{  
                    "Fn::GetAtt":[  
                        "ExecutionRole",
                        "Arn"
                    ]
                },
                "Cpu":{  
                    "Ref":"ContainerCpu"
                },
                "Memory":{  
                    "Ref":"ContainerMemory"
                },
                "NetworkMode":"awsvpc",
                "RequiresCompatibilities":[  
                    "FARGATE"
                ],
                "ContainerDefinitions":[  
                    {  
                        "Name":{  
                            "Ref":"TaskName"
                        },
                        "Cpu":{  
                            "Ref":"ContainerCpu"
                        },
                        "Memory":{  
                            "Ref":"ContainerMemory"
                        },
                        "Image":{  
                            "Ref":"ImageUrl"
                        },
                        "PortMappings":[  
                            {  
                                "ContainerPort":{  
                                    "Ref":"ContainerPort"
                                }
                            }
                        ]
                    }
                ]
            }
        },
        "Service":{  
            "Type":"AWS::ECS::Service",
            "Properties":{  
                "ServiceName":"spring-boot-app",
                "Cluster":{  
                    "Ref":"ECSFargateCluster"
                },
                "LaunchType":"FARGATE",
                "DeploymentConfiguration":{  
                    "MaximumPercent":200,
                    "MinimumHealthyPercent":75
                },
                "DesiredCount":1,
                "NetworkConfiguration":{  
                    "AwsvpcConfiguration":{  
                        "AssignPublicIp":"ENABLED",
                        "SecurityGroups":[  
                            {  
                                "Ref":"SecurityGroupECS"
                            }
                        ],
                        "Subnets":[ 
						{  
								"Fn::ImportValue": {
								  "Fn::Sub": "${NetworkStackName}-PublicSubnet1AID"
								},
								"Fn::ImportValue": {
								  "Fn::Sub": "${NetworkStackName}-PublicSubnet1BID"
								}
						}]
                    }
                },
                "TaskDefinition":{  
                    "Ref":"TaskDefinition"
                }
            }
        }
    }
}